# CosmicBoard Backend API

## Project Overview
Express.js backend API for CosmicBoard that handles all database operations and serves both web and mobile frontends. This is the central data layer for all CosmicBoard applications.

## Related Projects
- **Web Frontend**: `/Users/sammuthu/Projects/cosmicboard` - Next.js web application
- **Mobile App**: `/Users/sammuthu/Projects/cosmicboard-mobile` - React Native/Expo mobile application
- **Nginx Config**: `/Users/sammuthu/Projects/nginx-reverse-proxy` - Reverse proxy configuration

## Architecture
- **API Only**: Pure Express.js API backend
- **Database**: PostgreSQL with Prisma ORM
- **Clients**: Serves both web and mobile frontends
- **Port**: 7778 (changed from 3001)
- **CORS**: Configured for cross-origin requests

## Tech Stack
- Express.js
- TypeScript
- Prisma ORM
- PostgreSQL
- CORS middleware
- dotenv for environment management

## Database Schema (Prisma)
```prisma
model Project {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  metadata    Json?       // Stores flexible data like colors, icons
  references  Reference[]
  tasks       Task[]
}

model Task {
  id          String    @id @default(cuid())
  projectId   String
  content     String    // Title of the task
  priority    Priority  @default(MEDIUM)
  status      Status    @default(ACTIVE)
  metadata    Json?     // Stores contentHtml, tags, dueDate
  project     Project   @relation(fields: [projectId], references: [id])
}

model Reference {
  id        String   @id @default(cuid())
  projectId String
  title     String
  content   String
  url       String?
  category  Category @default(DOCUMENTATION)
  priority  Priority @default(MEDIUM)
  tags      String[]
  project   Project  @relation(fields: [projectId], references: [id])
}
```

## API Endpoints

### Projects
- `GET /api/projects` - List all projects
- `GET /api/projects/:id` - Get project details with tasks and references
- `POST /api/projects` - Create new project
- `PUT /api/projects/:id` - Update project
- `DELETE /api/projects/:id` - Delete project

### Tasks
- `GET /api/tasks?projectId=xxx` - List tasks for a project
- `GET /api/tasks/:id` - Get task details
- `GET /api/current-priority` - Get highest priority active task
- `POST /api/tasks` - Create new task
- `PUT /api/tasks/:id` - Update task
- `POST /api/tasks/:id/complete` - Mark task as completed
- `DELETE /api/tasks/:id/delete` - Soft delete task
- `POST /api/tasks/:id/restore` - Restore deleted task
- `DELETE /api/tasks/:id/purge` - Permanently delete task

### References
- `GET /api/references?projectId=xxx` - List references for a project
- `POST /api/references` - Create new reference
- `PUT /api/references/:id` - Update reference
- `DELETE /api/references/:id` - Delete reference

### Utilities
- `GET /health` - Health check endpoint
- `GET /api/tasks/search?q=xxx` - Search tasks

## Development
```bash
npm install
npm run dev  # Runs on port 7778 with nodemon
```

## Environment Variables (.env)
```env
PORT=7778
DATABASE_URL="postgresql://cosmicuser:cosmic123!@localhost:5432/cosmicboard?schema=public"
NODE_ENV=development
```

## Database Setup
```bash
# Create database
createdb cosmicboard

# Run Prisma migrations
npx prisma db push

# Generate Prisma client
npx prisma generate

# View database
npx prisma studio
```

## Important Files
- `/src/server.ts` - Main Express server
- `/src/routes/` - API route handlers
- `/prisma/schema.prisma` - Database schema
- `/.env` - Environment configuration

## Data Transformation
The API provides backward compatibility with MongoDB field names:
- `id` → `_id` in responses
- `content` → `title` for tasks
- Metadata stored in JSONB includes: `contentHtml`, `tags`, `dueDate`
- Project population: Returns full project object when included

## Common Issues
1. **TypeScript compilation errors**: Check `tsconfig.json` has `noImplicitReturns: false`
2. **Port conflicts**: Ensure port 7778 is available
3. **Database connection**: Verify PostgreSQL is running and credentials are correct
4. **CORS errors**: Check allowed origins include frontend URLs

## Ports
- Backend API: 7778
- PostgreSQL: 5432
- Frontend: 7777
- Mobile Web: 8082

## Notes
- This is the only project that should connect to the database
- All frontends must go through this API
- Uses Prisma for type-safe database access
- JSONB fields provide flexibility for metadata storage